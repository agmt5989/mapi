[{
  $match: {
      created_at: {
           
          $gte: {{dateFrom}},
          $lte: {{dateTo}}
,
      },
      linked: true
  },
}, {
  $group: {
      _id: "$business",
      "Number of accounts connected": {
          $push: "$accountNumber",
      }
  }
},
{
  $lookup: {
      from: "businesses",
      let: {
          id: "$_id"
      },
      pipeline: [{
              $match: {
                  $expr: {
                      $eq: ["$_id", "$$id"]
                  }
              }
          },
          {
              $project: {
                  name: 1,owner:1
              }
          },
      ],
      as: "_id",
  },
},
{
  $unwind: "$_id"
},
{
$addFields: {
 "Business Owner": "$_id.owner" ,
}
},
{
  $lookup: {
      from: "users",
      let: {
          id: "$_id.owner"
      },
      pipeline: [{
              $match: {
                  $expr: {
                      $eq: ["$_id", "$$id"]
                  }
              }
          },
          {
              $project: {
                  firstName: 1, lastName: 1, email: 1, phone: 1,
              }
          },
      ],
      as: "Business Owner",
  },
},
{
  $unwind: "$Business Owner"
},

{
$addFields: {
"Number of unique accounts connected": {
  $reduce: {
    input: "$Number of accounts connected",
    initialValue: [],
    in: {
      $concatArrays: [
        "$$value",
        {
          $cond: [
            {
              $in: [
                "$$this",
                "$$value"
              ]
            },
            [],
            [
              "$$this"
            ]
          ]
        }
      ]
    }
  }
}
}
},
{
  $project: {
      _id: 0,
      "Company name": "$_id.name",
      "Number of unique accounts connected": {
          $size: "$Number of unique accounts connected"
      },
      "Number of accounts connected": {
          $size: "$Number of accounts connected"
      },
      "Business Owner":1,
      

  }
},
{$sort:{"Number of unique accounts connected":-1}}
]